# CM3D2.VRMenu.Plugin
ルームスケールVRでの操作性を改善するプラグイン。今のところHTC Vive専用です。メニュー表示以外はGripMovePluginを参考にして、同じような機能を実装しています。

## 機能
### コントローラのメニュー表示

コントローラからできる操作を増やすため、コントローラのトラックパッドにメニューを表示する機能を実装しました。
メニューの項目は独自に実装する必要がありますが、簡単に追加できるフレームワークを実装しているので、他のプラグインからでも難なく使えるかと思います。

### GUIパネル

GripMovePluginと同じGUIパネルを実装しています。GripMovePluginと違うのは、旧GUIをゲームGUIと同じ1枚のパネルに表示しているところです。

### コントローラ操作を再実装

コントローラによる操作は、公式の機能をほぼ無効化して、プラグイン側で再実装しました。
操作モードの変更は、メニューボタンで表示されるコントローラメニューから変更します。

トリガーもグリップも基本すべてのオブジェクトを掴むことができます。
ただし、掴んで動かしたときの挙動がトリガーとグリップで若干違います。（下表参照）

| 掴む対象 | トリガー | グリップ |
|:----------:|:-----------:|:------------:|
| 背景 | XZ回転およびY方向移動が無効 | XZ回転無効 |
| GUI | 制限なし | 制限なし |
| メイド | XZ回転無効 | 制限なし |
| オブジェクト | XZ回転無効 | 制限なし |
| IK | 制限なし | 制限なし |

### ポインタ

コントローラの先にある丸い半透明の球体はポインタです。掴むときやGUI操作するときのポインタになります。
ポインタの色はトリガーやグリップを押したときに掴むことができる対象によって変わります。

| 色 | 掴む対象 |
|:----------:|:-----------:|:------------:|
| 青 | 背景および何も掴めないとき |
| 白 | GUI |
| 黄 | メイド、オブジェクト、IK |
| 赤 | ※ |

※ポインタがデスクトップ上で他のウィンドウ上にあるためクリックできないとき

### 新MOVEモード

公式のMOVE-DIRモードは廃止して、代わりにワープによる移動を実装しました。

MOVEモードにしてトラックパッドを押すと白い球体が出現します。白い球体が移動先を示すポインタとなります。
白い球体は放物線軌道で計算していますが、放物線軌道の描画はサボっているので見えません。
地面の高さはトラックパッド左を押してるときはプレイヤーの実際の部屋の床の高さ、右を押してるときはゲーム内背景のy=0の高さとなります。

### コントローラメニュー版YotogiCommandTool

夜伽コマンドをコントローラメニューで実装しました。MODE -> YOTOGI でYOTOGIモードにすると、トラックパッドにコマンドが表示されます。

### IKモード

GripMovePluginも入れるとGripMovePluginのIKモードが使えるようになります。MODE -> IK でIKードに入れます。

## インストール

CM3D2.VRMenu.Plugin.dllをUnityInjectorフォルダに、CM3D2.VRMenu.Plugin.Patcher.dllをしばりすのLoaderフォルダに入れてください。
GripMovePluginを入れている場合は、追加でCM3D2.VRMenuWithGripMove.Plugin.dllをUnityInjectorフォルダに入れてください。でないと、競合して変な動きをします。

## メニューからキー入力をしたい

C#のコードを書く必要がありますが、簡単にできます（多分）。CM3D2.VRMenu.MyKeyInput.csを見てください。
このファイルは他のプラグイン等には依存していないので、単体でAutoCompileできると思います。

## 制限

現在、開発バージョンです。やりたかったことはほぼ実装完了していますが、テストがまだまだ不十分なので、動かないところが多いかもしれません。

## ビルド方法

参照してるライブラリのパスを解決させればビルドできると思います。依存ライブラリはCMLibraryフォルダに入れて開発していました。

## プラグイン開発者向け

本プラグインはVR版でしかロードできないので、通常版でも動くプラグインでVR用コントローラメニューを追加する場合は、リフレクションを使ってください。
単にメニューを追加するだけなら、CM3D2.VRMenu.MyKeyInput.csと同じようにやればいいと思います。

## ライセンス

私の書いたコードはMITライセンスとします。

## お約束

- MODはKISSサポート対象外です。
- MODを利用するに当たり、問題が発生してもKISSは一切の責任を負いかねます。
- カスタムメイド3D2を購入されている方のみが利用できます。
- カスタムメイド3D2上で表示する目的以外の利用は禁止します。
- これらの事項は http://kisskiss.tv/kiss/diary.php?no=558 を優先します。

